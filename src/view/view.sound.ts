/*
global
zzfx
zzfxV
G_model_isSoundEnabled
*/

const G_view_setVolume = (v: number) => (zzfxV = v); //eslint-disable-line no-global-assign
const view_sounds = {
  talk: [
    0.6,
    0,
    326,
    0.08,
    ,
    0.07,
    1,
    0.25,
    ,
    33,
    -111,
    0.01,
    ,
    ,
    2.9,
    0.8,
    0.06,
    0.22,
    0.05,
    0.01,
  ],
  talkEnd: [
    0.6,
    0,
    326,
    0.08,
    ,
    0.07,
    1,
    0.15,
    0.1,
    33,
    -111,
    0.01,
    ,
    ,
    2.9,
    0.6,
    0.05,
    0.52,
    0.05,
    0.01,
  ],
  buyItem: [
    ,
    ,
    182,
    0.03,
    ,
    0.07,
    1,
    0.01,
    -66,
    -35,
    -869,
    0.14,
    0.12,
    0.8,
    ,
    ,
    0.16,
    0.38,
    ,
    0.04,
  ],
  sellItem: [, , 8, 0.04, , 0.19, 2, 0.4, , 0.1, 607, 0.19, , 0.4, 1.6],
  pickupItem: [
    ,
    ,
    756,
    0.12,
    0.08,
    0.13,
    4,
    2.35,
    55,
    ,
    ,
    ,
    0.15,
    ,
    ,
    ,
    ,
    0.36,
    ,
    0.04,
  ],
  btn: [
    ,
    ,
    53,
    0.01,
    ,
    0,
    ,
    0.73,
    -35.4,
    ,
    684,
    0.01,
    0.6,
    0.2,
    -0.4,
    ,
    0.51,
    0.11,
    0.03,
  ],
  btn2: [
    1.5,
    0,
    834,
    ,
    0.01,
    ,
    ,
    0.01,
    ,
    ,
    356,
    ,
    0.18,
    ,
    ,
    0.1,
    0.07,
    0.01,
    0.01,
  ],
  btnCancel: [
    ,
    0,
    272,
    0.02,
    0.13,
    0,
    2,
    0.83,
    -6.5,
    ,
    -17,
    ,
    ,
    ,
    ,
    ,
    0.04,
    0.37,
    0.04,
  ],
  eqp: [
    2.01,
    ,
    1509,
    0.05,
    0.03,
    0.06,
    4,
    1.51,
    ,
    -0.2,
    827,
    0.02,
    ,
    ,
    81,
    0.1,
    0.09,
    0.14,
    0.05,
  ],
  // more like "wound"
  hitSpell1: [
    2.4,
    0,
    606,
    ,
    ,
    0.12,
    1,
    0.68,
    -31,
    -5.1,
    ,
    ,
    0.06,
    ,
    ,
    0.1,
    0.17,
    ,
    0.06,
    0.3,
  ],
  // more like "flame"
  hitSpell2: [
    ,
    ,
    807,
    ,
    0.13,
    0,
    3,
    0.66,
    -13,
    -24,
    ,
    ,
    ,
    ,
    ,
    0.5,
    0.18,
    ,
    0.25,
  ],
  alert: [
    0.3,
    0,
    398,
    0.02,
    0.01,
    0.04,
    1,
    0.29,
    0.1,
    ,
    959,
    0.08,
    ,
    ,
    ,
    ,
    0.04,
    0.25,
    0.22,
  ],
  alertMinor: [
    0.3,
    ,
    0,
    0.05,
    ,
    0.02,
    2,
    1.76,
    5.3,
    ,
    ,
    ,
    ,
    ,
    ,
    0.1,
    ,
    0.68,
    0.05,
    0.19,
  ],
  alertEvent: [
    0.8,
    0,
    174.6141,
    0.03,
    0.13,
    0.09,
    3,
    0.92,
    ,
    ,
    -65,
    0.06,
    ,
    0.1,
    ,
    ,
    ,
    0.37,
  ],
  alertEvent2: [
    ,
    0,
    365,
    ,
    0.02,
    0.31,
    1,
    1.08,
    ,
    ,
    ,
    ,
    ,
    0.9,
    -303,
    0.1,
    ,
    0.53,
    ,
    0.23,
  ],

  bless: [
    0.3,
    0,
    1809,
    0.11,
    0.22,
    0.11,
    ,
    0.05,
    ,
    ,
    46,
    0.03,
    ,
    ,
    ,
    ,
    ,
    0.14,
    0.21,
    0.01,
  ],

  dyingGolem: [
    ,
    0,
    53,
    0.11,
    0.21,
    0.01,
    2,
    0.53,
    ,
    ,
    ,
    ,
    0.44,
    ,
    -0.1,
    0.9,
    0.49,
    0.27,
    0.17,
  ],
  dyingFairy: [
    0.5,
    0,
    918,
    ,
    0.16,
    0.01,
    1,
    0.47,
    ,
    49,
    58,
    0.06,
    0.01,
    0.2,
    -2.9,
    ,
    ,
    ,
    0.16,
  ],
  dyingGoblin: [
    0.3,
    -0.05,
    1598,
    0.06,
    0.19,
    0.01,
    4,
    0.27,
    0.5,
    0.2,
    ,
    ,
    ,
    ,
    ,
    ,
    ,
    ,
    0.01,
  ],
  projectileBow: [
    ,
    ,
    8,
    0.06,
    ,
    0,
    4,
    0.04,
    ,
    ,
    -40,
    0.02,
    0.03,
    0.7,
    ,
    ,
    0.37,
    ,
    0.02,
    0.1,
  ],
  projectileBow2: [
    0.5,
    0,
    450,
    0.06,
    0.01,
    0.21,
    ,
    1.79,
    9.9,
    -38,
    541,
    0.06,
    0.05,
    ,
    3.8,
    0.2,
    ,
    0.31,
    0.01,
  ],
  projectileCast: [
    0.3,
    ,
    1983,
    0.16,
    ,
    0.03,
    4,
    2.51,
    ,
    -43,
    ,
    ,
    ,
    ,
    ,
    0.8,
    ,
    0.03,
    0.17,
    0.01,
  ],

  castSpellCharge: [
    1.5,
    ,
    723,
    0.16,
    0.17,
    0.13,
    3,
    1.29,
    40,
    -0.1,
    ,
    ,
    0.33,
    ,
    0.1,
    0.4,
    0.08,
    ,
    ,
    0.98,
  ],

  levelUp: [
    0.6,
    0,
    1250,
    0.02,
    ,
    ,
    3,
    1.52,
    -4.2,
    13,
    234,
    0.06,
    0.04,
    ,
    ,
    ,
    0.06,
    ,
    0.2,
    0.27,
  ],
  levelUp2: [
    ,
    0,
    88,
    ,
    ,
    0.19,
    1,
    2.55,
    ,
    2,
    235,
    0.02,
    0.14,
    ,
    3.2,
    ,
    0.32,
    0.53,
    0.18,
  ],
  gainRenown: [
    0.5,
    ,
    6,
    0.1,
    ,
    0.05,
    2,
    0,
    ,
    0.1,
    471,
    ,
    0.03,
    ,
    1,
    ,
    0.08,
    0.74,
    0.01,
    0.38,
  ],

  unlockDoor: [0.3, 0, 1727, , , 0.14, 1, 2.66, 0.4, 28, -517, 0.03],
  stepGrass: [, , 1266, 0.1, , 0.03, 4, 1.96, , 91, , , , , 0.7, 0.2, 0.11],
  stepFloor: [
    ,
    ,
    207,
    0.04,
    ,
    0,
    4,
    1.25,
    -0.3,
    91,
    -21,
    0.01,
    ,
    ,
    ,
    0.1,
    0.03,
    0.32,
  ],

  // use this for an advanced spell that Dunns or Radmila uses
  magHit: [, , 1512, , , 0.21, 1, 0.22, 6.3, , , , , 0.4, -3.6, , 0.23, , 0.13],

  // same for this one, as a harsh curse or something
  magHit2: [
    0.4,
    ,
    753,
    0.1,
    ,
    0.05,
    2,
    1.71,
    27,
    ,
    24,
    0.07,
    ,
    ,
    5.3,
    0.1,
    ,
    ,
    0.13,
  ],

  // maybe good in a cutscene
  lava: [
    ,
    ,
    53,
    0.1,
    0.08,
    0.05,
    3,
    0.12,
    -9.1,
    0.4,
    ,
    ,
    0.04,
    0.3,
    -2.4,
    ,
    ,
    ,
    0.05,
    0.54,
  ],
  doorOpen: 'snd/door-open.mp3',
};

const G_view_loadSounds = async () => {
  const promises: Promise<void>[] = [];
  for (let i in view_sounds) {
    const url = view_sounds[i];
    if (typeof url === 'string') {
      promises.push(
        new Promise((resolve, reject) => {
          const fullUrl = 'res/' + url;
          const sound = new Audio(fullUrl);
          sound.autoplay = false;
          sound.oncanplay = () => {
            sound.oncanplay = null;
            sound.currentTime = 99999999999;
            const soundDuration = sound.currentTime;
            sound.currentTime = 0;
            sound.onended = function () {
              sound.pause();
              sound.currentTime = 0;
            };
            view_sounds[i] = {
              sound,
              audio: sound,
              soundDuration,
            };
            resolve();
          };
          sound.addEventListener('error', e => {
            console.error(e);
            reject(
              'Cannot load sound: name="' + i + '", url="' + fullUrl + '"'
            );
          });
          sound.src = fullUrl;
        })
      );
    }
  }
  await Promise.all(promises);
};

const cloneSound = function (soundObj) {
  const s = {
    ...soundObj,
    //soundDuration merged in from soundObj
    audio: soundObj.audio.cloneNode(),
    soundName: name,
    duration: 0,
    isPlaying: false,
    isPaused: false,
  };
  s.sound = s.audio;
  return s;
};

const G_view_playSound = (soundName: string) => {
  // if (!G_model_isSoundEnabled()) {
  //   return;
  // }

  const soundObj = view_sounds[soundName] as any;
  if (!soundObj) {
    console.error('No sound exists with name: ' + soundName);
    return;
  }
  const soundVolume = 0.3;

  if (soundObj.length) {
    G_view_setVolume(soundVolume);
    zzfx(...soundObj);
  } else {
    const soundCloned = cloneSound(soundObj);
    const { sound } = soundCloned;
    sound.volume = soundVolume;
    sound.play();
    soundObj.lastStartTimestamp = performance.now();
    soundObj.isPlaying = true;
  }
};
