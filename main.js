(()=>{async function e(){}let t=e=>{let t=[];for(let l in e)t.push(`${l}:${e[l]}`);return t.join(";")},l=(e,t)=>{ie(e,t)},r=function(e,l){var r;let i=[],n=null==l?void 0:l.style;n&&(l.style=t(n));let a=Array.prototype.slice.call(arguments,2);for(let e=0;e<a.length;e++){let t=a[e];if("string"==typeof t)i.push(te(t));else if(void 0!==(null===(r=t)||void 0===r?void 0:r.length))for(let e=0;e<t.length;e++)t[e]&&i.push(t[e]);else{if(!t.type)throw Error("Invalid child provided to superfine: "+JSON.stringify(t));i.push(t)}}return le(e,l||{},i)};e();let i=function(e){let t={},l={};return t["sadelica.json"]=e=>(L.set("curIN2f","sadelica.json"),void 0===L.get("alinea_dockmaster_asked_job")&&L.set("alinea_dockmaster_asked_job",!1),l.gl0=()=>{L.set("curIN2n","gl0"),l.Cmk()},l.Cmk=()=>{L.set("curIN2n","Cmk"),B.say("An official-looking dockworker resides in this building, sitting behind a desk of papers.  She meticulously inks a quill and writes, glancing up only momentarily as you enter.",l.b2t)},l.b2t=()=>{L.set("curIN2n","b2t"),B.choose("What do you ask?","b2t",[{t:"What does the Dockmaster do?",cb:l.yiQ,c:()=>L.get("alinea_dockmaster_asked_job")},{t:"What is your name?",cb:l.TAO,c:()=>!0},{t:"What is your job?",cb:l.Vc5,c:()=>!0},{t:"Nevermind.",cb:l.sPI,c:()=>!0}])},l.yiQ=()=>{L.set("curIN2n","yiQ"),B.say("She sighs and puts her quill down.",l.uf8)},l.uf8=()=>{L.set("curIN2n","uf8"),B.say('"Basically, I\'m in charge here.  You want to bring your caravan to the docks? You have to go through me.  You want to park your boat at my port?  You have to ask me.  You want access to the warehouses.  You guessed it: ask me."',l.Y0n)},l.Y0n=()=>{L.set("curIN2n","Y0n"),B.say('"Now like I said, I have a lot of these kinds of requests, and I have to answer ALL of them.  So please, stop bothering me."',l.Hxk)},l.Hxk=()=>{L.set("curIN2n","Hxk"),B.say("She picks up her quill and resumes writing.",l.b2t)},l.TAO=()=>{L.set("curIN2n","TAO"),B.say('"Hmph.  You must be immigrants.  I\'m Claire.  Dockmaster Claire."',l.b2t)},l.Vc5=()=>{L.set("curIN2n","Vc5"),L.set("alinea_dockmaster_asked_job"),l.b8O()},l.b8O=()=>{L.set("curIN2n","b8O"),B.say("\"I am the Dockmaster in Alinea.  It's a very busy job.  So unless you have business with me, I'd appreciate it you left here and didn't make any trouble.\"",l.b2t)},l.sPI=()=>{L.set("lasIN2f",L.get("curIN2f"));let e=t["main.json"];e?e():B.say("EXECUTION WARNING, no file exists named main.json. You are probably running a subset of all the files, and not the whole scenario. "+Object.keys(t),t.exit)},void 0===e?l.gl0():e&&l[e](),L.state),t.exit=()=>{B.exit()},{files:t,scope:l}}(),n=()=>{dl(!1);let e=Le("map");nl(e),T(e),Yl()};window.addEventListener("load",async()=>{await Ye([["packed","packed.png",16,16,2,2,["terrain2","terrain1","actors1","misc1"]],["map","map.png",64,64,1,1,["map"]]]),z(),h(),n()});let a=(e,t,l)=>{if(0===l)return[[e,t]];{let l=[];for(let r=-1;r<=1;r++)for(let i=-1;i<=1;i++)l.push([e+i,t+r]);return l}},s=(e,t)=>Math.floor(Math.random()*(t-e)+e),o=(e,t,l,r,i)=>{if(t===e)return 0;let[n,a]=l,o=s(n,a);De(ce(t),-o);let[c,u]=me(t),d=St(15,c,u,""+o),f=xl(i);return At(f,d),ke(e,!0),r&&Ml(r),o},c=[(e,t)=>{},(e,t)=>{let l=(e,t)=>{let[l,r]=me(e),[i,n]=me(t);return[i-l,n-r]};if(((e,t)=>{let[r,i]=l(e,t);return Math.abs(r)<6&&Math.abs(i)<6})(e,wt(t.player))){let r=((e,t)=>{let[r,i]=l(e,t);return 0===i?r>0?[I]:[N]:0===r?i>0?[k]:[b]:r>0&&i>0?[S,k,I]:r>0&&i<0?[D,b,I]:r<0&&i>0?[E,k,N]:[M,b,N]})(e,wt(t.player));for(let l in r)if(A(e,r[l],t))break}}],u=!1,d=!1,f=e=>{let t=il();u?d||(d=!0,setTimeout(()=>{u=!1,d&&(d=!1,f(e))},16)):(u=!0,Dl(),jl(e,t))},h=()=>{let e={40:k,34:S,35:E,37:N,12:x,39:I,36:M,38:b,33:D,98:k,99:S,97:E,100:N,101:x,102:I,103:M,104:b,105:D,81:M,87:b,69:D,65:N,83:x,68:I,90:E,88:k,67:S};window.addEventListener("keydown",t=>{let l=al();if(ul())return;let{which:r}=t,n=e[r]||r,a=wt(l.player),s=xl(l);switch(!0){case(c=+n)>=1&&c<=9:t.preventDefault(),o=n,m(),_(l.player,o,l);break;case 27===n:m(),Yl(),f(l);break;case 192===n:let e=Yt(s,a),[r,u,d]=e[0]||[];r&&w(r,a,u,d,s);break;case 32===n:{let e=zt(s,a)[0]||[];if(e){let t=_e(e);t&&(e=>{let t=bl();t.splice(0,t.length),Nl(!0),dl(!0),rl(!0),ll(!0),Yl(),(e=>{let t=i.files[e+".json"];t?t():console.error(`Cannot play in2 dialog, no key exists: '${e}'`)})(e)})(t)}}default:if(!t.shiftKey&&n>48&&n<=57){let e=n-49,t=ue(a)[e];if(t){let l=dt(t);mt(t)?(yl(e),g(l,a)):gt(t)&&v(e,a)}}if(t.shiftKey&&n>48&&n<=57||192===t.which){let e=Yt(s,a),t=n-49,[l,r,i]=e[t]||[];l&&w(l,a,r,i,s)}}var o,c});let t=Oe();t.onmousemove=e=>{let t=al(),l=il();if(pl()){let{offsetX:r,offsetY:i}=e,n=vl(),s=wt(t.player),[o,c]=me(s),u=cl()*l,d=o*u+u/2,h=c*u+u/2,m=Math.floor(r/u),p=Math.floor(i/u);$l(d,h,r,i),Bt(a(m,p,n),xl(t)),f(t)}else Pl()},t.onmousedown=e=>{let t=hl();if(t){let l=al(),{offsetX:r,offsetY:i}=e,n=2*cl();t(Math.floor(r/n),Math.floor(i/n)),f(l)}}},m=()=>{Pl(),gl(),Lt(xl(al()));let e=hl();e&&e(-1,-1)},p=(e,t,l,r,i)=>{let n;if(1===e)n=i?lt:tt;else if(2===e)n=i?it:rt;else{if(3!==e)return;n=i?at:nt}let a=(o=n)[s(0,o.length)];var o;jt(r,a,t,l)},y=(e,t)=>{let[l,r]=me(e);p(t.lvl,l,r,t)},g=async(e,t)=>{Ml("use"),Yl(),await pt(e)(t)&&(he(t,e),yl(-1)),Yl()},v=async(e,t)=>{Ml("eqp"),ge(t,e),Yl()},w=(e,t,l,r,i)=>{let n=dt(e),a=ct(n);Pt(i,a,l,r),yt(e)&&(fe(t,e),Ml("acquire")),Yl(),T(al())},b="8",k="2",N="4",x="5",I="6",M="7",D="9",E="1",S="3",_=(e,t,l)=>{let r=wt(e);A(r,t,l),(e=>{let t=wt(e),[l,r]=me(t),{wx:i,wy:n}=e,a=i,s=n,o=sl();return l<0&&(i--,l=o-1),r<0&&(n--,r=o-1),l>=o&&(i++,l=0),r>=o&&(n++,r=0),Nt(e,i,n),pe(t,l,r),a!==i||s!==n})(e)?T(l):C()},A=(e,t,l)=>{let r=xl(l),[i,n,a,o,c]=((e,t,l)=>{let[r,i]=me(e),n=r,a=i;switch(t){case b:i--;break;case k:i++;break;case N:r--;break;case I:r++;break;case M:r--,i--;break;case D:r++,i--;break;case E:r--,i++;break;case S:r++,i++}let s=r,o=i,c=[n,a,s,o,!1],u=xl(l);if(u){let e=Ct(u,r,i);if(e&&!Kt(e))return c;if(_t(u,r,i))return c}return[r,i,s,o,!0]})(e,t,l);((e,t,l)=>{let[r,i]=me(e),n=r-t;ve(e,n>0?ae:0===n?i-l>0?se:ae:se)})(e,a,o),pe(e,i,n);let u=_t(r,a,o),d=Me(e);return u&&d!==Me(u)?(((e,t,l)=>{if(t===e)return 0;let[r,i]=Se(e),n=s(r,i+1);De(ce(t),-n);let[a,o]=me(t),c=St(0,a,o,""+n),u=xl(l);At(u,c),ke(e,!0),Ml("strike")})(e,u,l),!0):c},C=()=>{dl(!0);let e=al(),t=xl(e);for(let e=0;e<t.actors.length;e++)we(t.actors[e],!0);j()},T=e=>{let t=xl(e),l=wt(e.player),[r,i]=me(l);P(r,i,t),Dl(),jl(e,2)},j=()=>{let e=al(),t=xl(e);if(t.p.length){for(let e=0;e<t.p.length;e++){let l=t.p[e],[,r,i]=l;+new Date-r>=i&&(t.p.splice(e,1),e--)}return setTimeout(j,16),void T(e)}let l=wt(e.player);if(Ne(l),xe(l))return Ml("lose"),void setTimeout(()=>{n()},2e3);for(let l=0;l<t.actors.length;l++){let r=t.actors[l];if(xe(r))t.actors.splice(l,1),l--,y(r,t),Ml("dead"),r[13]&&r[13]();else{if(be(r)){we(r,!1);let t=Ie(r);return(0,c[t])(r,e),void setTimeout(j,1)}Ne(r)}}T(e),Yl(),setTimeout(()=>{dl(!1)},16)},$=e=>{let t=[];for(var l=0;l<e[0];++l)t.push(1===e.length?0:$(e.slice(1)));return t},P=(e,t,l)=>{let r=sl(),i=$([r,r]),n=(e,t,r,n)=>{let a=1,s=Math.abs(r-e),o=e<r?1:-1,c=Math.abs(n-t),u=t<n?1:-1,d=(s>c?s:-c)/2,f=0;for(;f++,!(f>10);){let f=e,h=t;if(void 0===i[h]||void 0===i[h][f])continue;if(0!==i[h][f]&&1!==a||(i[h][f]=a),Rt(Ct(l,f,h))&&(a=0),e===r&&t===n)break;let m=d;m>-s&&(d-=c,e+=o),m<c&&(d+=s,t+=u)}},a=l=>{for(let r=-l;r<=l;r++)n(e,t,e+r,t+l),n(e,t,e+r,t-l),n(e,t,e+l,t+r),n(e,t,e-l,t+r)};a(8),a(7),a(6),a(5),i[t][e]=1,((e,t)=>{for(let l=0;l<t.length;l++)for(let r=0;r<t[0].length;r++)e[l][r]=e[l][r]||t[l][r]})(l.explMap,i),l.visMap=i},Y={},z=()=>{Y["0,0,17,50"]=ot},O="Press any key or click here to continue.",q=!!window.IN2;var B=window.core={async init(){await e()},async say(e,t){if("object"==typeof e){if(1!==e.length)return void B.say(e[0],()=>{B.say(e.slice(1),t)});U(e)}else{if(e.length<=1)return void(t&&t());U(e),U(O,"#9D9D9D",t)}if(!q)return new Promise(e=>{K.setK(()=>{t&&t(),e()})})},async choose(e,t,l){return new Promise(t=>{U(e||"Select an option.","#9D9D9D"),U("-----","#9D9D9D");let r=l.filter(e=>!!e.c()).map((e,l)=>({text:l+1+".) "+e.t,cb:async()=>{this.onChoose(),await e.cb(),t()}}));r.forEach(({text:e,cb:t})=>{U(e,"#F7E26B",t)}),U("-----","#9D9D9D"),K.setK(async e=>{let l=r[e-1];l&&(K.setK(()=>{}),U(l.text,"#EB8931"),await l.cb(),t())})})},onChoose(){bl().forEach(e=>{e.cb=void 0})},async defer(e,t){t=t||[this.get("curIN2n"),this.get("curIN2f")],await e.apply(null,t)},exit(){K.setK(()=>{}),Nl(!1),rl(!1),ll(!1),Yl(),setTimeout(()=>{dl(!1)},100)}},L=window.player={state:{},init(){this.state={}},get(e){let t=(e,l)=>{let r=e.shift();if(!e.length)return void 0===l[r]?void 0:l[r];let i=l[r];return void 0!==i?t(e,i):void 0};return t(e.split("."),this.state)},set(e,t){t=void 0===t||t;let l=(e,r)=>{let i=e.shift();void 0!==i&&(e.length?(r[i]||(r[i]={}),l(e,r[i])):r[i]=t)};l(e.split("."),this.state)},setIfUnset(e,t){void 0===this.get(e)&&this.set(e,t)}},U=(e,t,l)=>{let r=bl(),i=r[r.length-1];i&&i.text===O&&r.splice(r.length-1,1),bl().push({text:e,color:t,cb:l}),Yl(),document.getElementById("dialog").scrollTop=999999},K=new function(){let e=()=>{};this.setK=t=>e=t,window.addEventListener("keydown",t=>{this.disabled||e(String.fromCharCode(t.which))})},R={},F=[],G=e=>null==e?e:e.key,X=function(e){this.tag[e.type](e)},V=(e,t,l,r,i)=>{"key"===t||("o"===t[0]&&"n"===t[1]?((e.tag||(e.tag={}))[t=t.slice(2)]=r)?l||e.addEventListener(t,X):e.removeEventListener(t,X):!i&&"list"!==t&&"form"!==t&&t in e?e[t]=null==r?"":r:null==r||!1===r?e.removeAttribute(t):e.setAttribute(t,r))},W=(e,t)=>{var l=e.props,r=3===e.tag?document.createTextNode(e.type):(t=t||"svg"===e.type)?document.createElementNS("http://www.w3.org/2000/svg",e.type,{is:l.is}):document.createElement(e.type,{is:l.is});for(var i in l)V(r,i,null,l[i],t);return e.children.map(e=>r.appendChild(W(e=Q(e),t))),e.dom=r},H=(e,t,l,r,i)=>{if(l===r);else if(null!=l&&3===l.tag&&3===r.tag)l.type!==r.type&&(t.nodeValue=r.type);else if(null==l||l.type!==r.type)t=e.insertBefore(W(r=Q(r),i),t),null!=l&&e.removeChild(l.dom);else{var n,a,s,o,c=l.props,u=r.props,d=l.children,f=r.children,h=0,m=0,p=d.length-1,y=f.length-1;for(var g in i=i||"svg"===r.type,Object.assign(Object.assign({},c),u))("value"===g||"selected"===g||"checked"===g?t[g]:c[g])!==u[g]&&V(t,g,c[g],u[g],i);for(;m<=y&&h<=p&&null!=(s=G(d[h]))&&s===G(f[m]);)H(t,d[h].dom,d[h++],f[m]=Q(f[m++]),i);for(;m<=y&&h<=p&&null!=(s=G(d[p]))&&s===G(f[y]);)H(t,d[p].dom,d[p--],f[y]=Q(f[y--]),i);if(h>p)for(;m<=y;)t.insertBefore(W(f[m]=Q(f[m++]),i),(a=d[h])&&a.dom);else if(m>y)for(;h<=p;)t.removeChild(d[h++].dom);else{var v={},w={};for(g=h;g<=p;g++)null!=(s=d[g].key)&&(v[s]=d[g]);for(;m<=y;)s=G(a=d[h]),o=G(f[m]=Q(f[m])),w[s]||null!=o&&o===G(d[h+1])?(null==s&&t.removeChild(a.dom),h++):null==o||1===l.tag?(null==s&&(H(t,a&&a.dom,a,f[m],i),m++),h++):(s===o?(H(t,a.dom,a,f[m],i),w[o]=!0,h++):null!=(n=v[o])?(H(t,t.insertBefore(n.dom,a&&a.dom),n,f[m],i),w[o]=!0):H(t,a&&a.dom,null,f[m],i),m++);for(;h<=p;)null==G(a=d[h++])&&t.removeChild(a.dom);for(var g in v)null==w[g]&&t.removeChild(v[g].dom)}}return r.dom=t},Q=e=>!0!==e&&!1!==e&&e?e:ee(""),J=e=>3===e.nodeType?ee(e.nodeValue,e):Z(e.nodeName.toLowerCase(),R,F.map.call(e.childNodes,J),e,null,1),Z=(e,t,l,r,i,n)=>({type:e,props:t,children:l,dom:r,key:i,tag:n}),ee=(e,t)=>Z(e,R,F,t,null,3);let te=ee,le=(e,t,l)=>Z(e,t,Array.isArray(l)?l:null==l?F:[l],null,t.key);var re,ie=(e,t)=>((e=H(e.parentNode,e,e.v||J(e),t)).v=t,e),ne=.3;ne=.3,re=(e=1,t=.05,l=220,r=0,i=0,n=.1,a=0,s=1,o=0,c=0,u=0,d=0,f=0,h=0,m=0,p=0,y=0,g=1,v=0,w=44100,b=99+r*w,k=i*w,N=n*w,x=v*w,I=y*w,M=2*Math.PI,D=(e=>0<e?1:-1),E=b+x+k+N+I,S=(o*=500*M/w**2),_=(l*=(1+2*t*Math.random()-t)*M/w),A=D(m)*M/4,C=0,T=0,j=0,$=0,P=0,Y=0,z=1,O=[],q=zzfxX.createBufferSource(),B=zzfxX.createBuffer(1,E,w))=>{for(q.connect(zzfxX.destination);j<E;O[j++]=Y)++P>100*p&&(P=0,Y=C*l*Math.sin(T*m*M/w-A),Y=D(Y=a?1<a?2<a?3<a?Math.sin((Y%M)**3):Math.max(Math.min(Math.tan(Y),1),-1):1-(2*Y/M%2+2)%2:1-4*Math.abs(Math.round(Y/M)-Y/M):Math.sin(Y))*Math.abs(Y)**s*e*ne*(j<b?j/b:j<b+x?1-(j-b)/x*(1-g):j<b+x+k?g:j<E-I?(E-j-I)/N*g:0),Y=I?Y/2+(I>j?0:(j<E-I?1:(j-E)/I)*O[j-I|0]/2):Y),C+=1-h+1e9*(Math.sin(j)+1)%2*h,T+=1-h+1e9*(Math.sin(j)**2+1)%2*h,l+=o+=500*c*M/w**3,z&&++z>d*w&&(l+=u*M/w,_+=u*M/w,z=0),f&&++$>f*w&&(l=_,o=S,$=1,z=z||1);return B.getChannelData(0).set(O),q.buffer=B,q.start(),q},zzfxX=new AudioContext;let ae=0,se=1,oe=(e,t,l)=>{let[r,i,n,a,s,o,c,u]=l;return[n,i,r,e,t,a,[],ae,s,!1,!1,u,0,()=>{},o,c]},ce=e=>e[5],ue=e=>e[6],de=(e,t,l)=>{let r=ue(e),i=dt(t),n=ct(i);for(let i=0;i<r.length;i++){let a=r[i],s=dt(a);if(n===ct(s)){if(l){let e=ft(t),l=ht(a,e);r[i]=l}else{let t=ht(a,-1);if(t)r[i]=t;else{let t=ye(e),l=e[12];if(t){let r=dt(t);ct(r)===n?ge(e,-1):l>i&&ge(e,l-1)}r.splice(i,1)}}return}}l&&r.push(t)},fe=(e,t)=>{de(e,t,!0)},he=(e,t)=>{de(e,t,!1)},me=e=>e.slice(3,5),pe=(e,t,l)=>{e[3]=t,e[4]=l},ye=e=>ue(e)[e[12]]||null,ge=(e,t)=>{e[12]=t},ve=(e,t)=>{e[7]=t},we=(e,t)=>{e[9]=t},be=e=>e[9],ke=(e,t)=>{e[10]=t},Ne=e=>{ke(e,!1)},xe=e=>Ee(ce(e))<=0,Ie=e=>e[8],Me=e=>0===Ie(e)?0:1,De=(e,t)=>{e[0]+=t,e[0]<0?e[0]=0:e[0]>e[1]&&(e[0]=e[1])},Ee=e=>e[0],Se=e=>{let t=ye(e),[l,r]=[1,3];if(t){let[i,n]=vt(dt(t),e);l+=i,r+=n}return[l,r]},_e=e=>e[14]||"",Ae=null,Ce=null,Te=null,je=e=>{let[t,l,r,i]=ze(e.width,e.height),n=r/2,a=i/2;return l.translate(n,a),l.rotate(Math.PI/2),l.drawImage(e,-n,-a),t},$e=e=>{let[t,l,r]=ze(e.width,e.height);return l.translate(r,0),l.scale(-1,1),l.drawImage(e,0,0),t},Pe=e=>{let[,,,t,l]=e,[r,i]=ze(t,l);return Sl(e,0,0,1,i),r},Ye=async e=>{let t={},l={};await Promise.all(e.map(([e,r,i,n,a,s,o])=>new Promise(c=>{let u=new Image;u.onload=()=>{t[e]=u,((e,t,l,r,i,n,a)=>{let s=(t,l,r,i,n,a)=>e[t]=[l,r,i,n,a],o=(e,t,l)=>{let n=e;for(let e=0;e<l;e++)n=je(n);s(`${t}_r${l}`,n,0,0,r,i)},c=t.width/r/n,u=t.height/i/a;for(let e=0;e<a;e++)for(let a=0;a<n;a++){let d=l[e*n+a],f=0;for(let l=0;l<u;l++)for(let n=0;n<c;n++){let h=`${d}_${f}`,m=s(`${d}_${f}`,t,a*r*c+n*r,e*i*u+l*i,r,i);o(Pe(m),h,1),o(Pe(m),h,2),o(Pe(m),h,3);let p=$e(Pe(m));s(h+"_f",p,0,0,r,i),f++}}})(l,u,o,i,n,a,s),c()},u.src=r}))),Ce=t,Te=l},ze=(e,t)=>{let l=document.createElement("canvas");l.width=e,l.height=t;let r=l.getContext("2d");return r.imageSmoothingEnabled=!1,[l,r,e,t]},Oe=()=>{if(Ae)return Ae;{let[e,t]=ze(544,544);return e.id="canv",t.lineWidth=2,window.canvasDiv.appendChild(e),Ae=e,e}},qe=()=>Oe().getContext("2d"),Be={5011569:0,634050:1,255255255:2,25523198:3,256163:4,357193:5,"000":6,79103129:7,606060:8,803030:9,18411180:10,4132209:11,2295968:12,44232244:13,25114643:14,175191210:15},Le=e=>{let t={wx:0,wy:0,actor:["player","actors1",0,23,50,st(100),[Ve,[et,3]],0,0,!0,!1,0,0,0,"",""],gold:0},l={rooms:[],p:[],player:t,end:[]},r=ol(),i=sl(),n=r*r;for(let e=0;e<n;e++){let t={lvl:0,id:e,tiles:[],p:[],visMap:$([i,i]),explMap:$([i,i]),items:[],actors:[],mod:""};l.rooms.push(t)}l.rooms[0].lvl=1,Nt(t,0,0);for(let t=0;t<1;t++){let{tiles:r,mod:n,actors:a}=l.rooms[t],[,s]=ze(64,64),o=t%8,c=Math.floor(t/8);Sl(e+"_"+t+n,0,0,1,s);let{data:u}=s.getImageData(0,0,64,64),d=0;for(let e=0;e<u.length;e+=4){let t=Be[`${u[e+0]}${u[e+1]}${u[e+2]}`]||0,l=d%64,n=Math.floor(d/64);r[n*i+l]=["terrain1_"+t,t,l,n,!1];let s=Y[[o,c,l,n].join(",")];if(s){let e=oe(l,n,s);a.push(e)}d++}}return l},Ue=async(e,t,l,r,i,n)=>{if(n=n||await(async e=>new Promise(t=>{ml(!0),wl(e),fl((e,l)=>{e>-1&&l>-1?(Pl(),gl(),t([e,l])):t(null),fl(null),m()})}))(l)){let s=al(),[c,u]=n,d=a(c,u,l),f=!1;for(let l=0;l<d.length;l++){let[n,a]=d[l],c=_t(xl(s),n,a);c&&0===e&&(o(t,c,r,f?"":i,s),f=!0)}return f?(C(),!0):(Ml("cancel"),!1)}return!1},Ke=(e,t)=>()=>(Ml("gold"),kt(al().player,s(e,t)),!1),Re=[13,"Gold S",{onAcq:Ke(1,5)},0],Fe=[13,"Gold M",{onAcq:Ke(5,10)},1],Ge=[13,"Gold L",{onAcq:Ke(10,15)},1],Xe=[14,"Key",{async onUse(e){let t=al(),l=xl(t),[r,i]=me(e),n=a(r,i,1);for(let e=0;e<n.length;e++){let[r,i]=n[e],a=Ct(l,r,i);if(a){let e=Ut(a);if(e===Dt||e===Mt)return Ml("unlock"),Tt(l,r,i,Et),e===Mt&&p(l.lvl,r,i,l,!0),setTimeout(()=>{T(t)}),!0}}return Ml("cancel"),!1}},10],Ve=[2,"Knife",{getDmg:()=>[4,8]},1],We=[3,"Sword",{getDmg:()=>[8,16]},5],He=[3,"Fine Sword",{getDmg:()=>[16,24]},15],Qe=[6,"Scroll: Flame",{onUse:e=>Ue(0,e,0,[13,20],"flame")},50],Je=[6,"Scroll: Combust",{onUse:e=>(Ml("flame"),Ue(0,e,1,[18,28],"",me(e)))},25],Ze=[6,"Scroll: Fireball",{onUse:e=>Ue(0,e,1,[15,25],"flame")},75],et=[9,"Potion",{onUse:async e=>(De(ce(e),s(5,15)),!0)},50],tt=[Ve,We,Re,Qe,Je,et,Xe],lt=[[et,3],[Qe,3],[Je,2],[Ze,2]],rt=[We,Re,Fe,Qe,Je,He,et],it=[[Ze,2],[Qe,5],[et,5]],nt=[Fe,Ge,He,Qe,et,[et,2],Xe],at=[[4,"Magic Sword",{getDmg:()=>[30,55]},404],[[6,"Scroll: Eviscerate",{onUse:async e=>Ue(0,e,0,[32,40],"flame")},200],3]],st=e=>[e,e],ot=[2,"actors1","Dockmaster",st(6),0,"sadelica","STEP_TRIGGER",0],ct=(st(6),st(14),st(17),st(32),e=>e[1]),ut=e=>"misc1_"+e[0],dt=e=>2===e.length?e[0]:e,ft=e=>2===e.length?e[1]:1,ht=(e,t)=>{if(2===e.length){let l=e[1]+t;return l<0&&(l=0),e[1]=l,l?e:null}return t>0?[e,1+t]:null},mt=e=>!!pt(e),pt=e=>dt(e)[2].onUse,yt=e=>{let t=dt(e)[2].onAcq;return!t||t()},gt=e=>!!dt(e)[2].getDmg,vt=(e,t)=>{let l=e[2];return l.getDmg?l.getDmg(t):[0,0]},wt=e=>e.actor,bt=e=>[e.wx,e.wy],kt=(e,t)=>{e.gold+=t},Nt=(e,t,l)=>{e.wx=t,e.wy=l},xt=[3,4,5,6,9,10,11,12,13,14],It=[3,4,5,6,14],Mt=10,Dt=9,Et=0,St=(e,t,l,r)=>["misc_"+e,+new Date,500,t,l,r],_t=(e,t,l)=>{for(let r=0;r<e.actors.length;r++){let i=e.actors[r],[n,a]=me(i);if(n===t&&a===l)return i}let r=al();if(r){let e=wt(r.player),[i,n]=me(e);if(i===t&&n===l)return e}return null},At=(e,t)=>{e.p.push(t)},Ct=(e,t,l)=>{let r=sl();return t<0||t>=r||l<0||l>=r?null:e.tiles[l*sl()+t]},Tt=(e,t,l,r)=>{let i=Ct(e,t,l);i&&(i[0]="terrain1_"+r,i[1]=r)},jt=(e,t,l,r)=>{e.items.push([t,l,r])},$t=(e,t,l)=>{let r=[];for(let i=0;i<e.items.length;i++){let[,n,a]=e.items[i];t===n&&l===a&&r.push(e.items[i])}return r},Pt=(e,t,l,r)=>{let{items:i}=e;for(let e=0;e<i.length;e++){let[n,a,s]=i[e];if(l===a&&r===s&&t===ct(dt(n)))return i.splice(e,1),!0}return!1},Yt=(e,t)=>{let l=[],[r,i]=me(t);for(let t=-1;t<=1;t++)for(let n=-1;n<=1;n++)l=l.concat($t(e,r+n,i+t));return l},zt=(e,t)=>{let l=[],[r,i]=me(t);for(let t=-1;t<=1;t++)for(let n=-1;n<=1;n++){let a=_t(e,r+n,i+t);a&&(l=l.concat([a]))}return l},Ot=(e,t,l)=>!!e.visMap[l][t],qt=(e,t,l)=>!!e.explMap[l][t],Bt=(e,t)=>{Lt(t);for(let l=0;l<e.length;l++){let[r,i]=e[l];Ft(Ct(t,r,i),!0)}},Lt=e=>{for(let t=0;t<e.tiles.length;t++)Ft(e.tiles[t],!1)},Ut=e=>(null==e?void 0:e[1])||0,Kt=e=>!xt.includes(Ut(e)),Rt=e=>It.includes(Ut(e)),Ft=(e,t)=>{e&&(e[4]=t)},Gt=null,Xt=!1,Vt=!1,Wt=-1,Ht=null,Qt=null,Jt=!1,Zt=[],el=!1,tl=!1,ll=e=>el=e,rl=e=>tl=e,il=()=>2,nl=e=>Gt=e,al=()=>Gt,sl=()=>64,ol=()=>8,cl=()=>16,ul=()=>Xt,dl=e=>Xt=e,fl=e=>Ht=e,hl=()=>Ht,ml=e=>Vt=e,pl=()=>Vt,yl=e=>Wt=e,gl=()=>yl(-1),vl=()=>Qt,wl=e=>{Qt=e},bl=()=>Zt,kl=()=>Jt,Nl=e=>Jt=e,xl=e=>{let t=e.player,[l,r]=bt(t),i=ol();return e.rooms[r*i+l]},Il={start:[,,17,.05,.21,.09,,2.92,,23,,,,,,.1,.37,,1],strike:[,0,822,.1,.08,.13,4,2.12,-12,-9.3,,,,,.2],dead:[2,,449,.01,,.08,3,2.15,-10,,,,,,,.2,.12,.36,.01],lose:[.3,,306,.08,.2,.83,2,.92,,-1.7,-5,.06,.18,,,.1,,.87,.09],eqp:[.5,,1966,,.13,0,4,1.15,-18,,,,,.1,-.6,,,.1,.06],use:[,,19,.01,,.05,4,.55,-.2,.8,,.04,,.4,-5,,,,.02],flame:[,,569,.01,,.42,3,.3,,.6,,,,1.1,3,,.16,.92],sell:[,0,853,.04,,,1,2.63,,.3,,,,,-.4,,.14,.13,.01],gold:[,0,457,,.23,,1,1.58,,,,,.07,,,,,.69],acquire:[.3,,14,.03,,.07,3,.3,,48,,,,,,,,,.04],cancel:[,0,177,.02,,.07,,.21,,-.4,764,.11,,,,,.06,.28,.03],talk:[,.3,527,.02,.03,0,2,.18,,-70,13,,,.1,,.6,.11],unlock:[,,823,.01,.03,0,3,.01,22,,,,.04,,6.3,,.18,,.06],win:[,,1257,.17,.17,.16,,.56,,,669,,.53,.8,-4.6,,.23,.8,.15]},Ml=e=>{ne=.3,re(...Il[e])},Dl=()=>{let e=Oe();_l(0,0,e.width,e.height,"black")},El=(e,t)=>{(t=t||qe()).globalAlpha=e},Sl=(e,t,l,r,i)=>{r=r||1,i=i||qe();let[n,a,s,o,c]="string"==typeof e?Te[e]:e;i.drawImage(n,a,s,o,c,t,l,o*r,c*r)},_l=(e,t,l,r,i,n,a)=>{(a=a||qe())[n?"strokeStyle":"fillStyle"]=i,a[n?"strokeRect":"fillRect"](e,t,l,r)},Al=(e,t,l,r,i)=>{let[n,a]=me(e),[s,o]=t,c=(e=>e[1]+"_"+(e[2]+(e[10]?1:0))+(e[7]===ae?"_f":""))(e),u=cl()*l;Sl(c,r+n*u-s*u,i+a*u-o*u,l)},Cl=(e,t,l,r,i)=>{l=l||1;let[n,,,a,s,o]=e,c=cl(),u=c*l/2,d=c*l,[f,h]=t,m=r+a*d-f*d,p=i+s*d-h*d;if(n&&Sl(n,m,p,l),o){let e=qe();e.font="16px monospace",e.fillStyle="#FFF",e.fillText(o,m+u-(2===o.length?9:5),p+u+5)}},Tl=(e,t,l,r,i,n,a)=>{let s=ut(e),[o,c]=t,u=cl()*i;Sl(s,n+l*u-o*u+8,a+r*u-c*u+8,i-1)},jl=(e,t)=>{let l=ol(),r=cl(),i=e.player,[n,a]=bt(i),s=r*t,o=e.rooms[a*l+n],c=wt(i),u=(e=>{let t=wt(e.player),l=sl(),[r,i]=me(t),n=[r-8,i-8,17,17];return n[0]<0?n[0]=0:n[0]+n[2]>=l&&(n[0]=l-n[2]),n[1]<0?n[1]=0:n[1]+n[3]>=l&&(n[1]=l-n[3]),n})(e),[d,f,h,m]=u;Al(c,u,t,0,0);for(let e in o.tiles){let[l,,r,i]=o.tiles[e],n=r*s-d*s,a=i*s-f*s;qt(o,r,i)?Sl(l,n,a,t):_l(n,a,s,s,"black",!0)}for(let e in o.items){let[l,r,i]=o.items[e],n=dt(l);Ot(o,r,i)&&Tl(n,u,r,i,t,0,0)}for(let e in o.tiles){let[,,l,r,i]=o.tiles[e],n=_t(o,l,r),a=l*s,c=r*s;Ot(o,l,r)?n&&Al(n,u,t,0,0):qt(o,l,r)&&(El(.15),_l(a,c,s,s,"black",!1),El(1)),i&&_l(a,c,s,s,"#ccc",!0)}for(let e=0;e<o.p.length;e++)Cl(o.p[e],u,t,0,0)},$l=(e,t,l,r)=>{let i=Ol("tgt");ql(i,{display:"block"});let n=i.children[0];n.setAttribute("x1",""+e),n.setAttribute("x2",""+l),n.setAttribute("y1",""+t),n.setAttribute("y2",""+r)},Pl=()=>{ml(!1),ql(Ol("tgt"),{display:"none"})},Yl=()=>{let e=al(),t=Ol("rightPane"),r=Ol("leftPane"),i=Ol("dialog");ql(t,{width:""}),l(r,Rl(e)),l(t,Fl(e)),l(i,Ll()),ql(document.body.children[0],{display:"flex"})},zl={},Ol=e=>document.getElementById(e),ql=(e,t)=>{for(let l in t)e.style[l]=t[l]},Bl=e=>{let t=zl[e];if(!t){let[l,r]=ze(32,32);Sl(e,0,0,2,r),t=l.toDataURL(),zl[e]=t}return t},Ll=()=>{let e=bl(),t=kl();return r("div",{style:{height:t?"512px":"0px",opacity:t?"1":"0"}},r("div",{className:"dialog-bg",style:{opacity:t?"1":"0"}}),r("div",{className:"title"},"DIALOG"),e.map(({text:e,color:t,cb:l})=>r("div",{className:"dialog-line"+(l?" dialog-line-choice":""),style:{color:t||""},onclick:()=>{l&&l()}},e)))},Ul=0,Kl=(e,t,l)=>{if(!e)return r("div",{className:"item hrz"});let i=dt(e),n=ft(e),a=ct(i),s=ut(i),o=Bl(s),c=ye(l)===e,u=e=>()=>{let r=l[12],i=((e,t,l)=>{let r=e+l;if(r<0||r>=t.length)return e;let i=t[e];return t[e]=t[e+l],t[e+l]=i,e+l})(t,ue(l),e),n=r;i===r&&(n=r-e),c&&(n=t+e),ge(l,n),Yl()},d=[];return mt(e)&&d.push(r("div",{className:"menu-item",onclick:async()=>{yl(t),g(i,l)}},"USE")),gt(e)&&!c&&d.push(r("div",{className:"menu-item",onclick:async()=>{v(t,l)}},"EQP")),r("div",{className:"item hrz",style:{"justify-content":"flex-start",background:t===Wt?"#444":"unset"}},r("div",{className:"vrt menu-item-ctr"},r("div",{className:"cyc-item",onclick:u(-1)},"up"),r("div",{className:"cyc-item",onclick:u(1)},"dn")),r("div",{style:{margin:"5px",width:"20px"}},t+1+". "),r("div",{className:"vrt menu-item-ctr"},d),r("img",{style:{margin:"2px"},src:o}),r("div",{style:{color:c?"#9ef":"unset"}},`${a} ${n>1?"("+n+")":""}`))},Rl=e=>{let t=el;return r("div",{id:"leftPane"},(e=>{let t=wt(e),l=ue(t),i=[],n=kl();for(let e=0;e<24;e++)i.push(Kl(l[e],e,t));return r("div",{id:"invDiv"},r("div",{className:"inventory",onscroll:e=>{var t;Ul=null===(t=null==e?void 0:e.target)||void 0===t?void 0:t.scrollTop},scrollTop:Ul},r("div",{className:"title"},"INVENTORY"),i),r("div",{className:"overlay",style:{width:n?"100%":"0"}}))})(e.player),r("div",{className:"overlay",style:{left:0,width:t?"100%":"0"}}))},Fl=e=>{let t=tl;return r("div",null,r("div",{className:"ctrl info-item hrz"},r("div",{id:"reset-item",className:"menu-item",style:{width:"80px"},onclick:()=>n()},"Reset")),r("div",{className:"ctrl info-item",style:{height:"100px"}}),r("div",{className:"pickup info-item",scrollTop:0},((e,t)=>{let l=wt(e),i=Yt(t,l);return r("div",null,r("div",{className:"title"},"NEARBY ITEMS"),i.map(([e,i,n],a)=>((e,t,l,i,n,a)=>{if(!e)return r("div",{key:t,className:"item hrz",style:{width:"155px",background:"#555"}});let s=dt(e),o=ft(e),c=ct(s),u=ut(s),d=Bl(u);return r("div",{key:c+t,className:"item hrz",style:{width:"155px",background:"#555","justify-content":"flex-start"},onclick:()=>w(e,a,i,n,l)},r("span",null,"!@#$%^&*()_+"[t]+"."),r("img",{src:d}),r("span",null,`${c} ${o>1?"("+o+")":""}`))})(e,a,t,i,n,l)))})(e.player,xl(e))),r("div",{className:"overlay",style:{right:0,width:t?"100%":"0"}}))}})();